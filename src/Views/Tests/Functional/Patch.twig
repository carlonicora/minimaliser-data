<?php
namespace {{ meta.namespace }}Tests\Functional\{{ data.attributes.objectNamePlural}};

use CarloNicora\JsonApi\Document;
use CarloNicora\JsonApi\Objects\ResourceObject;
use CarloNicora\Minimalism\Enums\HttpCode;
use CarloNicora\Minimalism\Services\Encrypter\Encrypter;
use CarloNicora\Minimalism\TestSuite\Factories\MinimalismServiceFactory;
use {{ meta.namespace }}Enums\{{ meta.projectName }}Dictionary;
use {{ meta.namespace }}Tests\Abstracts\AbstractFunctionalTest;
use {{ meta.namespace }}Tests\Validators\{{ data.attributes.objectName }}Validator;
use {{ meta.namespace }}Tests\Data\{{ meta.projectName }}\{{ data.attributes.objectNamePlural }}Data;
use Exception;

class Patch{{ data.attributes.objectNamePlural }} extends AbstractFunctionalTest
{
    /**
     * @return Document[][]
     * @throws Exception
     */
    public function data(
    ): array
    {
        ${{ data.attributes.objectName | lower }}Document = new Document();
        ${{ data.attributes.objectName | lower }} = new ResourceObject(
            type: LinkneticDictionary::{{ data.attributes.objectName }}->value,
            id: MinimalismServiceFactory::create(Encrypter::class)->encryptId(3),
        );

{% for fieldIdentifier in data.relationships['fields'].data %}{% set field = lookupIncluded('field', fieldIdentifier.id, included) %}{% if field.meta.isId == false%}{% if field.attributes.name != 'updatedAt' and field.attributes.name != 'createdAt'%}
        ${{ data.attributes.objectName | lower }}->attributes->add(name: '{{ field.attributes.name}}', value: {% if field.attributes.phpType == 'string' %}'{{ field.attributes.name }}NewValue'{% elseif field.attributes.phpType == 'bool' %}false{% else %}{% if field.meta.DbFieldType == 'DbFieldType::IntDateTime' %}time(){% else %}{% if field.meta.isForeignKey == true %}MinimalismServiceFactory::create(Encrypter::class)->encryptId(1){% else %}5{%endif%}{% endif %}{% endif %});
{% endif %}{% endif %}{% endfor %}

        ${{ data.attributes.objectName | lower }}Document->addResource(${{ data.attributes.objectName | lower }});

        return [
            '{{ data.attributes.objectName | lower }}' => [
                ${{ data.attributes.objectName | lower }}Document
            ]
        ];
    }

    /**
    * @test
    * @return void
    * @throws Exception
    * @covers \Linknetic\Minimalism\Api\Models\{{ data.attributes.objectNamePlural }}::patch()
    */
    public function SHOULD_Return412_WHEN_UserUpdates{{ data.attributes.objectName }}WithoutPayload(
    ): void
    {
        /** @noinspection UnusedFunctionResultInspection */
        $this->runApiCall(
            expectedResult: HttpCode::PreconditionFailed,
            endpointParams: [{{ data.attributes.objectNamePlural }}Data::Value3->value],
        );
    }

    /**
    * @test
    * @param Document $document
    * @dataProvider data
    * @return void
    * @throws Exception
    * @covers \Linknetic\Minimalism\Api\Models\{{ data.attributes.objectNamePlural }}::patch()
    */
    public function SHOULD_Return204_WHEN_UserUpdates{{ data.attributes.objectName }}(
        Document $document,
    ): void
    {
        /** @noinspection UnusedFunctionResultInspection */
        $this->runApiCall(
            expectedResult: HttpCode::NoContent,
            endpointParams: [{{ data.attributes.objectNamePlural }}Data::Value3->value],
            payload: $document,
        );
    }
}